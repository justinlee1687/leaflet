<!DOCTYPE html>
<html>

<head>
  <title>leaflet-map-csv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Load Leaflet code library - see updates at http://leafletjs.com/download.html -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Load jQuery and PapaParse to read data from a CSV file -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet-src.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@3"></script>

  <!-- Load Esri Leaflet Renderers -->
  <!-- This will hook into Esri Leaflet to get renderer info when adding a feature layer -->
  <script src="https://unpkg.com/esri-leaflet-renderers@3"></script>

  <!-- Position the map with Cascading Style Sheet (CSS) -->
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
    }
  </style>

</head>

<body>

  <!-- Insert HTML division tag to layout the map -->
  <div id="map"></div>

  <!-- Insert Javascript (.js) code to create the map -->
  <script>

    // Set up initial map center and zoom level
    var map = L.map('map', {
      center: [45.34832719159016, -75.78607684724913], // EDIT latitude, longitude to re-center map
      zoom: 10,  // EDIT from 1 to 18 -- decrease to zoom out, increase to zoom in
      scrollWheelZoom: true,
      tap: false
    });

    var littleton = L.marker([39.61, -105.02]).bindPopup('This is Littleton, CO.'),
      denver = L.marker([39.74, -104.99]).bindPopup('This is Denver, CO.'),
      aurora = L.marker([39.73, -104.8]).bindPopup('This is Aurora, CO.'),
      golden = L.marker([39.77, -105.23]).bindPopup('This is Golden, CO.');

    var cities = L.layerGroup([littleton, denver, aurora, golden]);

    var overlayMaps = {
      "Cities": cities
    };

    /* Control panel to display map layers */
    var controlLayers = L.control.layers(null, null, {
      position: "topright",
      collapsed: false
    }).addTo(map);

    // display Carto basemap tiles with light features and labels
    var light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map); // EDIT - insert or remove ".addTo(map)" before last semicolon to display by default
    // controlLayers.addBaseLayer(light, 'Carto Light basemap');

    const apiKey = "AAPK95f0bc344de14945b18b5e0de5d6ad3bG2YtG5mSUOtSZhrI9fyQOFBFCxjQXLvtsiQDmlyCCRStmsc4IPXcOjre7Lf7n3GV";
    /* L.esri.Vector.vectorBasemapLayer("arcgis/modern-antique", {
        apikey: apiKey
      }).addTo(map); */


    //L.esri.basemapLayer('Streets').addTo(map);
    /* const heatmap = L.esri
      .featureLayer({
        url: "https://services1.arcgis.com/DwLTn0u9VBSZvUPe/arcgis/rest/services/Servicewalk/FeatureServer/0",
        token: apiKey
      })
      .addTo(map); */


    // see more basemap options at https://leaflet-extras.github.io/leaflet-providers/preview/

    var drugstorelist = []
    var conveniencestoreslist = []
    var clubstorelist = []
    var independentlist = []
    var supermarketlist = []
    var otherslist = []


    // Read markers data from data.csv
    $.get('./data.csv', function (csvString) {

      // Use PapaParse to convert string to array of objects
      var data = Papa.parse(csvString, { header: true, dynamicTyping: true }).data;

      // For each row in data, create a marker and add it to the map
      // For each row, columns `Latitude`, `Longitude`, and `Title` are required
      for (var i in data) {
        var row = data[i];

        /* var marker = L.marker([row.Latitude, row.Longitude], {
          opacity: 1
        }).bindPopup(row.StoreName + '</br> Address: ' + row.Address  + '</br> ShopType: ' + row.shoptype  + '</br> Phone: ' + String(row.phone) + '</br> Opening Hours: ' + row.opening_ho );
        
        marker.addTo(map); */

        if (row.shoptype == "Convenience stores and gas stations") {
          var conveniencestores = L.marker([row.Latitude, row.Longitude], {
            opacity: 1
          }).bindPopup(row.StoreName + '</br> Address: ' + row.Address + '</br> ShopType: ' + row.shoptype + '</br> Phone: ' + String(row.phone) + '</br> Opening Hours: ' + row.opening_ho);
          conveniencestoreslist.push(conveniencestores);
        } else if (row.shoptype == "Drugstores") {
          var drugstores = L.marker([row.Latitude, row.Longitude], {
            opacity: 1
          }).bindPopup(row.StoreName + '</br> Address: ' + row.Address + '</br> ShopType: ' + row.shoptype + '</br> Phone: ' + String(row.phone) + '</br> Opening Hours: ' + row.opening_ho);
          drugstorelist.push(drugstores);
        } else if (row.shoptype == "Mass merchandisers / club stores") {
          var clubstores = L.marker([row.Latitude, row.Longitude], {
            opacity: 1
          }).bindPopup(row.StoreName + '</br> Address: ' + row.Address + '</br> ShopType: ' + row.shoptype + '</br> Phone: ' + String(row.phone) + '</br> Opening Hours: ' + row.opening_ho);
          clubstorelist.push(clubstores);
        } else if (row.shoptype == "Independent and specialty stores") {
          var independent = L.marker([row.Latitude, row.Longitude], {
            opacity: 1
          }).bindPopup(row.StoreName + '</br> Address: ' + row.Address + '</br> ShopType: ' + row.shoptype + '</br> Phone: ' + String(row.phone) + '</br> Opening Hours: ' + row.opening_ho);
          independentlist.push(independent);
        } else if (row.shoptype == "Supermarkets and traditional formats") {
          var supermarket = L.marker([row.Latitude, row.Longitude], {
            opacity: 1
          }).bindPopup(row.StoreName + '</br> Address: ' + row.Address + '</br> ShopType: ' + row.shoptype + '</br> Phone: ' + String(row.phone) + '</br> Opening Hours: ' + row.opening_ho);
          supermarketlist.push(supermarket);
        } else if (row.shoptype == "Other") {
          var others = L.marker([row.Latitude, row.Longitude], {
            opacity: 1
          }).bindPopup(row.StoreName + '</br> Address: ' + row.Address + '</br> ShopType: ' + row.shoptype + '</br> Phone: ' + String(row.phone) + '</br> Opening Hours: ' + row.opening_ho);
          otherslist.push(others);
        }
      }
      var conveniencestoreslistfinal = L.layerGroup(conveniencestoreslist)
      var drugstorelistfinal = L.layerGroup(drugstorelist)
      var clubstorelistfinal = L.layerGroup(clubstorelist)
      var independentlistfinal = L.layerGroup(independentlist)
      var supermarketlistfinal = L.layerGroup(supermarketlist)
      var otherslistfinal = L.layerGroup(otherslist)
      //show as overlay
      controlLayers.addOverlay(conveniencestoreslistfinal, "convenience stores");
      controlLayers.addOverlay(drugstorelistfinal, "drugstorelist");
      controlLayers.addOverlay(clubstorelistfinal, "clubstorelist");
      controlLayers.addOverlay(independentlistfinal, "independent stores");
      controlLayers.addOverlay(supermarketlistfinal, "supermarket stores");
      controlLayers.addOverlay(otherslistfinal, "others stores");

      //actual show on map
      map.addLayer(conveniencestoreslistfinal);
      map.addLayer(drugstorelistfinal);
      map.addLayer(clubstorelistfinal);
      map.addLayer(independentlistfinal);
      map.addLayer(supermarketlistfinal);
      map.addLayer(otherslistfinal);

      fetch("data.geojson").then(res => res.json()).then(data => {
        // add GeoJSON layer to the map once the file is loaded
        L.geoJson(data).addTo(map);
      });

    });

    map.attributionControl.setPrefix(
      'View <a href="https://github.com/HandsOnDataViz/leaflet-map-csv" target="_blank">code on GitHub</a>'
    );

  </script>
</body>

</html>